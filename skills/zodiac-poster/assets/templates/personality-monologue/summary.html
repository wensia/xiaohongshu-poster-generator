<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>性格独白风 - 结尾页模板</title>

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- 导出依赖 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="../../js/poster-utils.js"></script>

  <!-- 字体 -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      background: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    #poster-container {
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .controls {
      margin-top: 20px;
      display: flex;
      gap: 12px;
    }
    .btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn-primary {
      background: #C4653A;
      color: white;
    }
    .btn-primary:hover {
      background: #A85432;
      transform: translateY(-2px);
    }
    .btn:disabled {
      background: #999;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <div id="poster-container"></div>
  <div class="controls">
    <button id="export-btn" class="btn btn-primary">导出 PNG</button>
  </div>

  <script type="text/babel">
    // ============================================
    // 配色系统（性格独白风）
    // ============================================
    const COLORS = {
      accent: '#C4653A',       // 强调色
      textPrimary: '#3D3835',  // 主文字
      textSecondary: '#6B6461',// 次要文字
      divider: '#D4CFC8',      // 分隔线
      bgStart: '#FAF6F1',      // 渐变起点
      bgMid: '#F5EDE4',        // 渐变中点
      bgEnd: '#F0E6D9'         // 渐变终点
    };

    // 行间距
    const LINE_HEIGHT = 61;

    // ============================================
    // 默认数据（可通过 window.POSTER_DATA 覆盖）
    // ============================================
    const DEFAULT_DATA = {
      zodiac: '射手座',
      topic: '性格独白',
      sectionTitle: '写给射手',
      // 总结正文
      content: [
        '你不是不在乎',
        { before: '只是', highlight: '太懂事', after: '' },
        '不想让人为难',
        '',
        '希望每个射手',
        { before: '都能被', highlight: '温柔以待', after: '' }
      ],
      // 结语两行
      endingLine1: '愿你眼里有光',
      endingLine2: '心中有梦',
      pageNum: '0 8'
    };

    // 从 window 读取数据，与默认值合并
    const DATA = { ...DEFAULT_DATA, ...(window.POSTER_DATA || {}) };

    // ============================================
    // 星座图标组件
    // ============================================
    function ZodiacIcon({ zodiac }) {
      const sagittariusIcon = (
        <svg viewBox="0 0 100 100" width="56" height="56" fill="none" stroke={COLORS.accent} strokeWidth="1.5">
          <line x1="20" y1="80" x2="80" y2="20"/>
          <line x1="80" y1="20" x2="55" y2="20"/>
          <line x1="80" y1="20" x2="80" y2="45"/>
          <line x1="25" y1="45" x2="55" y2="75"/>
        </svg>
      );
      return sagittariusIcon;
    }

    // ============================================
    // 正文行组件（支持居中模式）
    // ============================================
    function ContentLine({ item, y, centered = false }) {
      if (!item || item === '') {
        return null;
      }

      const textAnchor = centered ? "middle" : "start";

      if (typeof item === 'string') {
        return (
          <text y={y}
                fontFamily="Noto Serif SC, serif"
                fontSize="32"
                fill={COLORS.textPrimary}
                letterSpacing="2"
                textAnchor={textAnchor}>
            {item}
          </text>
        );
      }

      return (
        <text y={y}
              fontFamily="Noto Serif SC, serif"
              fontSize="32"
              letterSpacing="2"
              textAnchor={textAnchor}>
          {item.before && <tspan fill={COLORS.textPrimary}>{item.before}</tspan>}
          {item.highlight && <tspan fill={COLORS.accent}>{item.highlight}</tspan>}
          {item.after && <tspan fill={COLORS.textPrimary}>{item.after}</tspan>}
        </text>
      );
    }

    // ============================================
    // 结尾页组件
    // ============================================
    function SummaryPage({ data }) {
      return (
        <svg id="poster-svg" width="2160" height="2880" viewBox="0 0 1080 1440" xmlns="http://www.w3.org/2000/svg">
          {/* 背景渐变定义 */}
          <defs>
            <linearGradient id="bgGradient" x1="0%" y1="100%" x2="100%" y2="0%">
              <stop offset="0%" stopColor={COLORS.bgStart}/>
              <stop offset="50%" stopColor={COLORS.bgMid}/>
              <stop offset="100%" stopColor={COLORS.bgEnd}/>
            </linearGradient>
            <linearGradient id="lightOverlay" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stopColor="#FFF" stopOpacity="0.3"/>
              <stop offset="20%" stopColor="#FFF" stopOpacity="0"/>
              <stop offset="80%" stopColor="#000" stopOpacity="0"/>
              <stop offset="100%" stopColor="#000" stopOpacity="0.03"/>
            </linearGradient>
          </defs>

          {/* 背景 */}
          <rect width="1080" height="1440" fill="url(#bgGradient)"/>
          <rect width="1080" height="1440" fill="url(#lightOverlay)"/>

          {/* 页眉 */}
          <g id="header">
            <text x="100" y="130"
                  fontFamily="Noto Serif SC, serif"
                  fontSize="32"
                  fontWeight="500"
                  fill={COLORS.accent}
                  letterSpacing="2">
              {data.zodiac}
            </text>
            <text x="210" y="130"
                  fontFamily="Georgia, serif"
                  fontSize="24"
                  fill={COLORS.divider}>
              ·
            </text>
            <text x="240" y="130"
                  fontFamily="Noto Sans SC, sans-serif"
                  fontSize="24"
                  fontWeight="300"
                  fill={COLORS.textSecondary}
                  letterSpacing="3">
              {data.topic}
            </text>
            <g transform="translate(924, 74) rotate(-10)">
              <ZodiacIcon zodiac={data.zodiac} />
            </g>
          </g>

          {/* ⭐ 居中内容区域（与内容页的左对齐形成差异，增强仪式感） */}
          <g id="centered-content" transform="translate(540, 0)">
            {/* 章节标签 */}
            <text x="0" y="220"
                  fontFamily="Georgia, serif"
                  fontSize="26"
                  fill={COLORS.accent}
                  letterSpacing="8"
                  textAnchor="middle">
              EXTRA
            </text>

            {/* 章节标题 */}
            <text x="0" y="310"
                  fontFamily="Noto Serif SC, serif"
                  fontSize="64"
                  fontWeight="600"
                  fill={COLORS.textPrimary}
                  letterSpacing="6"
                  textAnchor="middle">
              {data.sectionTitle}
            </text>

            {/* 分隔线（居中） */}
            <rect x="-50" y="340" width="100" height="4" fill={COLORS.accent}/>

            {/* 总结正文（居中） */}
            <g id="summary" transform="translate(0, 520)">
              {data.content.map((item, index) => (
                <ContentLine
                  key={index}
                  item={item}
                  y={index * LINE_HEIGHT}
                  centered={true}
                />
              ))}
            </g>

            {/* 结语 */}
            <g id="ending" transform="translate(0, 480)">
            <text y="0"
                  fontFamily="Noto Serif SC, serif"
                  fontSize="30"
                  fontStyle="italic"
                  fill={COLORS.textSecondary}
                  textAnchor="middle"
                  letterSpacing="4">
              {data.endingLine1}
            </text>
            <text y="60"
                  fontFamily="Noto Serif SC, serif"
                  fontSize="30"
                  fontStyle="italic"
                  fill={COLORS.textSecondary}
                  textAnchor="middle"
                  letterSpacing="4">
              {data.endingLine2}
            </text>

            {/* END 标记 */}
            <g transform="translate(0, 140)">
              <line x1="-90" y1="0" x2="-30" y2="0"
                    stroke={COLORS.divider}
                    strokeWidth="2"/>
              <text x="0" y="8"
                    fontFamily="Georgia, serif"
                    fontSize="24"
                    fill={COLORS.accent}
                    textAnchor="middle"
                    letterSpacing="6">
                END
              </text>
              <line x1="30" y1="0" x2="90" y2="0"
                    stroke={COLORS.divider}
                    strokeWidth="2"/>
            </g>
          </g>
          </g>

          {/* 页脚 */}
          <g id="footer">
            <line x1="100" y1="1350" x2="980" y2="1350"
                  stroke={COLORS.divider}
                  strokeWidth="2"/>
            <text x="980" y="1390"
                  fontFamily="Georgia, serif"
                  fontSize="28"
                  fill={COLORS.textSecondary}
                  textAnchor="end"
                  letterSpacing="4">
              {data.pageNum}
            </text>
          </g>
        </svg>
      );
    }

    // ============================================
    // 渲染
    // ============================================
    ReactDOM.render(
      <SummaryPage data={DATA} />,
      document.getElementById('poster-container')
    );

    // ============================================
    // 导出功能
    // ============================================
    document.getElementById('export-btn').addEventListener('click', async function() {
      const btn = this;
      const originalText = btn.textContent;

      btn.disabled = true;
      btn.textContent = '导出中...';

      try {
        const filename = `${DATA.zodiac}_${DATA.topic}_结尾.png`;
        await window.PosterUtils.exportPoster({
          element: document.getElementById('poster-svg'),
          filename: filename,
          scale: 2,
          mode: 'svg'
        });
      } catch (error) {
        alert('导出失败: ' + error.message);
        console.error(error);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    });
  </script>
</body>
</html>
